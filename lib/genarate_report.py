import os
import sys
import re
import json
from pprint import pprint
import argparse
import commands

class Gen_Report_Html(object):
	def __init__(self, md5, ip_add, status):
		self.md5 = md5
		self.ip_add = ip_add
		self.status = status
		self.filename = "report/%s/%s.json" % (md5, md5)
		self.memory_dump = "mem.dmp"
		self.memory_analysis = "memory_analysis.zip"
		status, output = commands.getstatusoutput("cat report/%s/ip.txt" % md5)
	
		self.read_json()
		self.get_report()

		link = "<a href=\"http://%s/%s/index.html\" > Link </a>" %(self.ip_add, self.md5)
		lines = "%s;%s;%s;%s" %(self.md5, output, self.status, link)
		print lines
		os.system("echo \"%s\" >> report/results.csv" % (lines))	
	
	def read_json(self):
		with open(self.filename) as data_file:
			data = json.load(data_file)

		self.vstatus = data["Virus Status"]
		self.file_name = data["file_name"]
		self.file_size = str(data["file_size"])
		self.file_type = data["file_type"]			
		self.hash_md5 = data["hash"]["md5"]	
		self.hash_sha1 = data["hash"]["sha1"]	
		self.hash_sha256 = data["hash"]["sha256"]	
		self.virus_total = data["virustotal"]
		print self.file_size
		

	def gen_link(self):
		
		
		"""
		apihooks = "report/%s/out/apihooks.txt" %s self.md5	
		connscan = "report/%s/out/connscan.txt" %s self.md5	
		driverscan = "report/%s/out/driverscan.txt" %s self.md5	
		hivedump = "report/%s/out/hivedump.txt" %s self.md5	
		modscan = "report/%s/out/modscan.txt" %s self.md5	
		pslist = "report/%s/out/pslist.txt" %s self.md5	
		sockscan = "report/%s/out/sockscan.txt" %s self.md5	
		callbacks = "report/%s/out/callbacks.txt" %s self.md5	
		devicetree = "report/%s/out/devicetree.txt" %s self.md5	
		hivelist = "report/%s/out/hivelist.txt" %s self.md5	
		netscan = "report/%s/out/netscan.txt" %s self.md5	
		psscan = "report/%s/out/psscan.txt" %s self.md5	
		svcscan = "report/%s/out/svcscan.txt" %s self.md5	
		cmdscan = "report/%s/out/cmdscan.txt" %s self.md5	
		dlldump = "report/%s/out/dlldump.txt" %s self.md5	
		filescan = "report/%s/out/filescan.txt" %s self.md5	
		hivescan = "report/%s/out/hivescan.txt" %s self.md5	
		pstree = "report/%s/out/pstree.txt" %s self.md5	
		connections = "report/%s/out/connections.txt" %s self.md5	
		dlllist = "report/%s/out/dlllist.txt" %s self.md5	
		handles = "report/%s/out/handles.txt" %s self.md5	
		malfind = "report/%s/out/malfind.txt" %s self.md5	
		procdump = "report/%s/out/procdump.txt" %s self.md5	
		psxview = "report/%s/out/psxview.txt" %s self.md5	
		"""

	def get_report(self):
		
		f = open("report/%s/index.html" % self.md5, 'w')
		
		f.write("<html>")
		f.write("<body>")
		f.write("<table>")
		f.write("<tr>")
		f.write("<td> File Name :") 
		f.write("</td>") 
		f.write("<td>") 
		f.write(self.file_name)
		f.write("</td>")
		f.write("<td> File Size :") 
		f.write("</td>") 
		f.write("<td>")
		f.write(self.file_size)
		f.write("</td>")
		f.write("</tr>")

		f.write("<tr>")
		f.write("<td> File Type :") 
		f.write("</td>") 
		f.write("<td>") 
		f.write(self.file_type)
		f.write("</td>")
		f.write("<td> Virus Status :") 
		f.write("</td>") 
		f.write("<td>") 
		f.write(self.vstatus)
		f.write("</td>")
		f.write("</tr>")
		f.write("</table>")


		f.write("<table>")
		f.write("<tr>")
		f.write("<td> Hash MD5 :") 
		f.write("</td>") 
		f.write("<td>") 
		f.write(self.hash_md5)
		f.write("</td>")
		f.write("</tr>")
		f.write("<tr>")
		f.write("<td> Hash SHA1 :") 
		f.write("</td>") 
		f.write("<td>")
		f.write(self.hash_sha1)
		f.write("</td>")
		f.write("</tr>")

		f.write("<tr>")
		f.write("<td> Hash SHA256 :") 
		f.write("</td>") 
		f.write("<td>")
		f.write(self.hash_sha256)
		f.write("</td>")
		f.write("</tr>")

		f.write("<tr>")
		f.write("<td> Virus Total :") 
		f.write("</td>") 
		f.write("<td>")
		f.write(self.virus_total)
		f.write("</td>")
		f.write("</tr>")


		f.write("<tr>")
		f.write("<td> Memory Dump :") 
		f.write("</td>") 
		f.write("<td><a href='")
		f.write(self.memory_dump)
		f.write("'> %s </a></td>" % self.memory_dump)
		f.write("</tr>")

		f.write("<tr>")
		f.write("<td> Memory Analysis Report :") 
		f.write("</td>") 
		f.write("<td><a href='")
		f.write(self.memory_analysis)
		f.write("'> %s </a></td>" % self.memory_analysis)
		f.write("</tr>")

		f.write("</body>")
		f.write("</html>")
		f.close()


if __name__ == "__main__":
	Gen_Report_Html("d113cd13983a1633984f2a89ff1a868a","192.168.10.1","malware")




