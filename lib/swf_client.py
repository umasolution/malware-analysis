import subprocess
import time
import os
import json
from urlparse import urlparse
import re


class swf_Class():

	def __init__(self, file_name, md5):
		self.file_name = "report/"+md5+"/"+file_name
		self.report_name = "report/"+md5+"/"+file_name + "_swf.report"
		with open('data/string_sig/malware_swf') as malware:
                        self.malw=malware.read().splitlines()
		self.res = self.swf_scan()

	def swf_Score(self):
		if self.res == 0:
        		self.result = 0
		elif self.res == 2:
        		self.result = 2
		elif self.res >= 3:
        		self.result = 3
		else:
        		self.result = error

		return self.result

	def swf_scan(self):
		self.score = 0
		self.check = True
		os.system("swfdump -D " + self.file_name + " > "+ self.report_name)
		
		for mal in self.malw:
			datafile = file(self.report_name)
			found = False
			for line in datafile:
				if mal in line:
					self.score = 3

		with open(self.report_name, 'r') as myfile:
        		data=myfile.read().replace('\n', '')

		urls = re.findall('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', data)

		for url in urls:
        		o = urlparse(url)
        		self.url_full = o.geturl()
        		self.domain = o.netloc

			datafile = file('data/malware_url')
			found = False
			for line in datafile:
				if self.url_full in line:
					self.score = 3
					self.check = False

			if self.check == True:
				datafile = file('data/malware_url')
				found = False
				for line in datafile:
					if self.domain in line:
						self.score = 3


		return self.score

if __name__ == "__main__":
	res = swf_Class('swf-js.file', '31c032f34f1c2561488e898c451e0666')
	status = res.swf_Score()
	print status	
